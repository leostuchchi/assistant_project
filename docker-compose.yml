

services:
  # ============================================
  # 1. POSTGRESQL - –û–°–ù–û–í–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–•
  # ============================================
  postgres:
    container_name: personal-assistant-postgres
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: personal_assistant
      POSTGRES_USER: pa_admin
      POSTGRES_PASSWORD: ${DB_PASSWORD:-Admin_Pass_123!}
      PGDATA: '/var/lib/postgresql/data/pgdata'
    ports:
      - '${DB_PORT:-5432}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init_scripts/init_db.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./init_scripts/init_extensions.sql:/docker-entrypoint-initdb.d/02-extensions.sql
      - ./init_scripts/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U pa_admin -d personal_assistant']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - personal-assistant-network

  # ============================================
  # 2. REDIS - –ö–≠–® –ò –°–ï–°–°–ò–ò
  # ============================================
  redis:
    container_name: personal-assistant-redis
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - '${REDIS_PORT:-6379}:6379'
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - personal-assistant-network

  # ============================================
  # 3. OLLAMA - LLM –î–õ–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô
  # ============================================
  ollama:
    container_name: personal-assistant-ollama
    image: ollama/ollama:latest
    restart: unless-stopped
    ports:
      - '11435:11434'  # –ò–∑–º–µ–Ω–∏—Ç–µ –≤–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç –Ω–∞ 11435
    volumes:
      - ollama_data:/root/.ollama
      - ./models:/models
    environment:
      OLLAMA_HOST: 0.0.0.0
      OLLAMA_MODELS: /models
      OLLAMA_KEEP_ALIVE: 24h
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:11434/api/tags']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '2'
        reservations:
          memory: 4G
          cpus: '1'
    networks:
      - personal-assistant-network

  # ============================================
  # 4. INIT-DB - –û–î–ù–û–†–ê–ó–û–í–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–î
  # ============================================
  init-db:
    container_name: personal-assistant-init-db
    image: postgres:15-alpine
    restart: 'no'
    environment:
      PGHOST: postgres
      PGPORT: 5432
      PGDATABASE: personal_assistant
      PGUSER: pa_admin
      PGPASSWORD: ${DB_PASSWORD:-Admin_Pass_123!}
    volumes:
      - ./init_scripts/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
      - ./init_scripts/init_extensions.sql:/docker-entrypoint-initdb.d/extensions.sql
    command: >
      sh -c "
        echo '‚è≥ Waiting for PostgreSQL to be ready...' &&
        until pg_isready -h postgres -p 5432 -U pa_admin; do 
          echo 'PostgreSQL is not ready yet. Waiting...';
          sleep 2; 
        done &&
        echo '‚úÖ PostgreSQL is ready!' &&
        echo 'üîç Checking if database needs initialization...' &&
        if psql -c '\dt' | grep -q 'users'; then
          echo 'üìä Database already initialized. Skipping...';
        else
          echo 'üöÄ Initializing database...';
          psql -f /docker-entrypoint-initdb.d/init_db.sql;
          psql -f /docker-entrypoint-initdb.d/extensions.sql;
          echo 'üéâ Database initialized successfully!';
        fi
      "
    networks:
      - personal-assistant-network
    profiles:
      - init

volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      device: ${VOLUME_PATH:-./data}/postgres
      o: bind
  redis_data:
    driver: local
    driver_opts:
      type: none
      device: ${VOLUME_PATH:-./data}/redis
      o: bind
  ollama_data:
    driver: local
    driver_opts:
      type: none
      device: ${VOLUME_PATH:-./data}/ollama
      o: bind

networks:
  personal-assistant-network:
    driver: bridge
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥—É—é –ø–æ–¥—Å–µ—Ç—å —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-172.25.0.0/16}
